# 对话调试工具使用说明

## 功能概述

对话调试工具是一个可视化界面，用于查看和分析与大模型的对话详细信息，包括：
- 完整的系统提示词
- 模型的原始输出（前500字符）
- 对话上下文和历史记录
- 来源信息和调试路径

## 如何打开调试工具

### 方法：从文档助手面板打开

1. 上传或打开一个文档
2. 在右侧的"文档助手"面板中
3. 点击右上角的 **"调试"** 按钮（紫色按钮，带有Bug图标）
4. 调试工具窗口将会弹出

## 调试工具界面说明

### 左侧面板 - 对话列表

显示当前文档的所有对话消息：

- **用户消息**：绿色标签，显示用户提出的问题
- **AI回复**：紫色标签，显示AI助手的回答
- **消息序号**：每条消息有唯一的序号（#1, #2, ...）
- **创建时间**：消息的创建时间戳
- **刷新按钮**：重新加载最新的对话记录

**操作提示**：
- 点击任意消息可以查看详细信息
- 选中的消息会高亮显示为蓝色
- 鼠标悬停在消息上会显示浅色高亮效果

### 右侧面板 - 消息详情

显示选中消息的完整详细信息：

#### 1. 消息内容
显示用户问题或AI回复的完整内容。

#### 2. 系统提示词（仅AI回复）
显示用于生成此回复的完整系统提示词，包括：
- 系统角色定义
- 对话历史上下文
- 当前用户问题
- 相关文档内容
- 回答指令

**颜色：** 绿色背景，等宽字体显示
**长度：** 完整显示，不截断

#### 3. 模型原始输出（仅AI回复）
显示大模型返回的原始文本输出。

**颜色：** 紫色背景，等宽字体显示
**长度：** 最多显示500字符
**截断提示：** 如果输出超过500字符，会显示截断警告

#### 4. 来源信息（如果有）
以JSON格式显示引用的文档来源，包括：
- 章节ID
- 章节标题
- 相关性评分

#### 5. 调试路径（如果有）
以JSON格式显示文档树的遍历路径，用于调试查询逻辑。

#### 6. 元数据
显示消息的技术元数据：
- 消息ID（UUID）
- 文档ID
- 创建时间戳

## 使用场景

### 1. 调试提示词
查看实际使用的系统提示词，了解：
- 是否包含了正确的历史对话
- 文档上下文是否相关
- 指令是否清晰明确

### 2. 分析模型输出
比较模型原始输出和最终显示内容，检查：
- 输出质量
- 是否被正确处理
- 是否有意外的内容

### 3. 追踪对话上下文
查看完整的对话历史，分析：
- 上下文是否正确传递
- 历史对话是否影响当前回答
- 多轮对话的连贯性

### 4. 验证来源准确性
检查AI回答引用的文档来源：
- 来源章节是否相关
- 相关性评分是否合理
- 是否遗漏重要来源

## 快捷操作

- **关闭窗口**：点击右上角的 × 按钮，或按 ESC 键（需要在窗口内）
- **刷新列表**：点击左侧面板顶部的"刷新"按钮
- **切换消息**：在左侧列表中点击不同的消息

## 技术信息

### 数据来源
调试工具从后端API获取数据：
```
GET /api/documents/{document_id}/conversations?limit=100
```

### 数据字段
每条消息包含以下字段：
- `id`: 消息唯一标识
- `document_id`: 所属文档ID
- `role`: 消息角色（user/assistant）
- `content`: 消息内容
- `created_at`: 创建时间
- `sources`: 来源信息（JSON字符串）
- `debug_path`: 调试路径（JSON字符串）
- `system_prompt`: 系统提示词（完整）
- `raw_output`: 原始输出（截断到500字符）

### 前端实现
- 组件路径：`components/ConversationDebugModal.tsx`
- 使用React + TypeScript
- 样式采用内联样式（深色主题）
- 响应式布局，支持长内容滚动

## 注意事项

1. **性能考虑**：
   - 默认最多加载100条消息
   - 大量消息可能影响加载速度

2. **隐私提醒**：
   - 系统提示词可能包含敏感文档内容
   - 不要在不安全的环境中截图分享

3. **数据一致性**：
   - 调试信息仅在新版本系统中可用
   - 旧的对话记录可能缺少部分字段

4. **浏览器兼容性**：
   - 推荐使用现代浏览器（Chrome, Edge, Firefox）
   - 需要支持ES6+和Fetch API

## 常见问题

### Q: 调试按钮是灰色的/无法点击
A: 这表示系统正在处理对话（思考中），等待处理完成后即可使用。

### Q: 没有看到系统提示词或原始输出
A: 这些字段仅在新版本中保存。如果是旧的对话记录，可能不包含这些信息。

### Q: 原始输出显示"⚠ 输出已截断到 500 字符"
A: 这是正常的。为了节省存储空间，系统只保存前500字符。如需完整输出，请查看消息内容字段。

### Q: 如何导出调试信息？
A: 目前不支持直接导出。可以使用浏览器的复制功能手动复制需要的内容。

## 未来改进计划

可能的功能扩展：
- [ ] 导出调试信息为JSON文件
- [ ] 搜索和过滤消息
- [ ] 对比不同消息的提示词差异
- [ ] 显示Token使用量统计
- [ ] 支持深色/浅色主题切换
- [ ] 显示模型响应时间
- [ ] 添加提示词编辑和重试功能
